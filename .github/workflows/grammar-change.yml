name: 'Grammar Changes'

on:
  pull_request:

jobs:
  grammar-change-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Check if grammar changed
        id: grammar-diff
        run: |
          if git diff --name-only ${{ github.base_ref }} HEAD | grep -q '\.g4$'; then
            echo "::set-output name=changed::true"
          else
            echo "::set-output name=changed::false"
          fi

      - name: Apply label if grammar changed
        uses: actions-ecosystem/action-add-labels@v1
        if: steps.grammar-diff.outputs.changed == 'true'
        with:
          labels: grammar changed

      - name: Setup Java
        uses: actions/setup-java@v3
        if: steps.grammar-diff.outputs.changed == 'true'
        with:
          distribution: 'oracle'
          java-version: '11'

      - name: Download ANTLR
        if: steps.grammar-diff.outputs.changed == 'true'
        run: wget -O head/src/antlr/antlr.jar https://www.antlr.org/download/antlr-4.12.0-complete.jar

      - name: Generate files
        if: steps.grammar-diff.outputs.changed == 'true'
        run: java -jar head/src/antlr/antlr.jar -o src/Parsing/Generated -Dlanguage=CSharp src/antlr/TeXpressionMath.g4 -visitor -no-listener

      - name: Check diff against base
        if: steps.grammar-diff.outputs.changed == 'true'
        run: |
          git add .

          if git diff --quiet; then
            # There are no changes
            exit 0
          else
            # There are changes
            exit 1
          fi
